/* monitor-1.0.0.min.js 2016-01-11 */
var monitorCtrls=angular.module("monitorCtrls",["ui.grid","ui.grid.selection"]);monitorCtrls.controller("positionMonitor",["$scope","$http","$interval","$filter",function(a,b,c,d){a.curdeviceIndex=-1,a.curdeviceId=null,a.pbFlat="Stop",a.pageActive=!0,a.realTimeInfo="请选择一辆设备",a.getDataStatus,a.bgnTime=d("date")(new Date,"yyyy-MM-dd HH:mm"),a.endTime=d("date")(new Date,"yyyy-MM-dd HH:mm"),a.pbSpeed=90,a.updatePBSpeed=function(b){a.pbSpeed=240-50*b>0?240-50*b:10,a.curdeviceIndex>=0&&(a.Map.vehicles[a.curdeviceIndex].pbSpeed=a.pbSpeed)},a.openRMPage=function(){a.pageActive||(a.pageActive=!0,a.getLastData(),a.updateLastData(),a.clearPBData())},a.clearPBData=function(){a.curdeviceIndex>=0&&(a.Map.vehicles[a.curdeviceIndex].pbFlat=!1,a.Map.vehicles[a.curdeviceIndex].pbIndex=a.Map.vehicles[a.curdeviceIndex].pointArray.length-1)},a.getLastData=function(){b.get("data/getLastData.json").success(function(b){a.realTimeInfo="状态："+b.status+"；定位时间："+b.deviceUtcDate+"；速度："+b.speed+"km/h",a.Map.clearOverlays(),a.pbFlat="Stop",a.Map.addVerhicle(b,a.pbSpeed,0),a.curdeviceIndex=a.Map.showPosition(a.curdeviceId)})},a.updateLastData=function(){angular.isDefined(a.getDataStatus)||(a.getDataStatus=c(function(){a.getLastData()},5e3))},a.stopGetData=function(){angular.isDefined(a.getDataStatus)&&(c.cancel(a.getDataStatus),a.getDataStatus=void 0)},a.openPBPage=function(){a.pageActive&&(a.pageActive=!1,a.stopGetData(),a.getGpsDatas())},a.getGpsDatas=function(){b.get("data/getGpsDatas.json").success(function(b){a.Map.clearOverlays(),a.pbFlat="Stop",a.Map.addVerhicle(b,a.pbSpeed,1),a.curdeviceIndex=a.Map.showPath(a.curdeviceId)})},a.beginPlayBack=function(){a.pbFlat="Begin",a.Map.beginPlayBack(a.curdeviceId,function(b){a.$apply(function(){a.pbFlat="Stop"})})},a.pausePlayBack=function(){a.pbFlat="Pause",a.Map.pausePlayBack(a.curdeviceId)},a.stopPlayBack=function(){a.pbFlat="Stop",a.Map.stopPlayBack(a.curdeviceId)},b.get("data/getDevices.json").success(function(b){a.gridOptions.data=b}),a.gridOptions={enableColumnMenus:!1,enableSorting:!1,enableHiding:!1,enableRowSelection:!0,enableRowHeaderSelection:!1,multiSelect:!1,columnDefs:[{field:"name"},{field:"status"}],onRegisterApi:function(b){b.selection.on.rowSelectionChanged(a,function(b){a.curdeviceId=b.entity.id,a.pageActive?(a.clearPBData(),a.getLastData(),a.updateLastData()):(a.clearPBData(),a.stopGetData(),a.getGpsDatas())})}},a.$watch("pbFlat",function(){a.pbBegin="Begin"==a.pbFlat,a.pbPause="Pause"==a.pbFlat||"Stop"==a.pbFlat,a.pbStop="Stop"==a.pbFlat})}]),monitorCtrls.controller("statistics",["$scope",function(a){}]),monitorCtrls.controller("deviceManagement",["$scope",function(a){}]);var monitorDirectives=angular.module("monitorDirectives",[]);monitorDirectives.directive("baidumap",function(){return{restrict:"E",templateUrl:"tpls/BaiduMap.html",replace:!0,scope:!1,link:function(a){a.Map=new BaiduMap("baidu_map"),a.Map.init()}}}),monitorDirectives.directive("datetimepicker",function(){return{restrict:"EA",template:'<input id="datetimepicker" ng-model="model" class="rightMar" type="text">',replace:!0,scope:{model:"="},link:function(a,b,c){jQuery.datetimepicker.setLocale("de"),b.datetimepicker({i18n:{de:{months:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]}},format:"Y-m-d h:m"}),b.attr("size",12),b.css("text-align","center")}}}),monitorDirectives.directive("rangeslider",function(){return{restrict:"EA",template:'<input type="hidden" value="3" ng-model="pbSpeed"/>',replace:!0,scope:!1,link:function(a,b,c){b.jRange({from:1,to:5,step:1,scale:[1,2,3,4,5],width:150,showLabels:!1,snap:!0,onstatechange:function(b){a.updatePBSpeed(b)}})}}});var animating=null,BaiduMap=function(a){this.map=new BMap.Map(a),this.centerPoint=new BMap.Point(105.530519,36.967249),this.vehicles=[],this.init=function(){this.map.centerAndZoom(this.centerPoint,5),this.map.enableScrollWheelZoom(!0),this.map.addControl(new BMap.NavigationControl({type:BMAP_NAVIGATION_CONTROL_LARGE}))},this.clearOverlays=function(){animating&&clearTimeout(animating),animating=null,this.map.clearOverlays()},this.addVerhicle=function(a,b,c){var d,e=!1;for(d=this.vehicles.length-1;d>=0;d--)if(a.id==this.vehicles[d].id){e=!0;break}e?this.vehicles[d].updateData(a,b,c):this.vehicles.push(new vehicle(this.map,a,b,c))},this.showPosition=function(a){this.map.clearOverlays(),this.map.setZoom(9);for(var b=this.vehicles.length-1;b>=0;b--)if(a==this.vehicles[b].id)return this.vehicles[b].showPosition(),b;return-1},this.showPath=function(a){for(var b=this.vehicles.length-1;b>=0;b--)if(a==this.vehicles[b].id)return this.vehicles[b].drawPath(),b;return-1},this.beginPlayBack=function(a,b){for(var c=this.vehicles.length-1;c>=0;c--)if(a==this.vehicles[c].id){this.vehicles[c].playBack(b);break}},this.pausePlayBack=function(a){animating&&clearTimeout(animating),animating=null;for(var b=this.vehicles.length-1;b>=0;b--)if(a==this.vehicles[b].id){this.vehicles[b].pausePlayBack();break}},this.stopPlayBack=function(a){animating&&clearTimeout(animating),animating=null;for(var b=this.vehicles.length-1;b>=0;b--)if(a==this.vehicles[b].id){this.vehicles[b].stopPlayBack();break}}},vehicle=function(a,b,c,d){this.map=a,this.name=b.name,this.id=b.id,this.beginMarker=null,this.endMarker=null,this.path=null,this.animatedPathArray=[],this.carMk=new BMap.Marker(this.map.centerPoint,{icon:new BMap.Icon("image/car.png",new BMap.Size(52,26))}),this.pbFlat=!1,this.pbIndex=0,this.pbStayTimes=0,this.stayMkArray=[],this.pbSpeed=c,this.curData=function(a,b){return 0==b?[a.baiduLng,a.baiduLat,a.speed,a.deviceUtcDate,a.status,a.distance]:null}(b,d),this.datas=function(a,b){return 1==b?a.datas:[]}(b,d),this.pointArray=function(a,b){if(1==b){for(var c=[],d=0;d<a.length;d++)c.push(new BMap.Point(a[d][1],a[d][0]));return c}return[]}(this.datas,d),this.updateData=function(a,b,c){if(this.name=a.name,this.pbSpeed=b,1==c){this.pointArray=[];for(var d=0;d<a.datas.length;d++)this.pointArray.push(new BMap.Point(a.datas[d][1],a.datas[d][0]));this.datas=a.datas}else this.curData=[a.baiduLng,a.baiduLat,a.speed,a.deviceUtcDate,a.status,a.distance]},this.showPosition=function(){var a=new BMap.Point(this.curData[0],this.curData[1]);this.map.setCenter(a),this.carMk.setPosition(a),this.carMk.setRotation(-90),this.map.addOverlay(this.carMk);var b={width:180,height:80,title:this.name},c="状态："+this.curData[4]+"<br>定位时间："+this.curData[3]+"<br>速度："+this.curData[2]+"km/h",d=new BMap.InfoWindow(c,b);this.carMk.addEventListener("click",function(){this.map.openInfoWindow(d,a)})},this.drawPath=function(){this.map.setViewport(this.pointArray),this.map.removeOverlay(this.beginMarker),this.map.removeOverlay(this.endMarker),this.beginMarker=new BMap.Marker(this.pointArray[0],{title:"起点"}),this.endMarker=new BMap.Marker(this.pointArray[this.pointArray.length-1],{title:"终点"}),this.map.addOverlay(this.beginMarker),this.map.addOverlay(this.endMarker),this.map.removeOverlay(this.path),this.path=new BMap.Polyline(this.pointArray,{strokeColor:"green"}),this.map.addOverlay(this.path),this.carMk.setPosition(this.pointArray[0]),this.carMk.setRotation(135),this.map.addOverlay(this.carMk)},this.playBack=function(a){if(this.pbIndex==this.pointArray.length-1&&0==this.pbFlat){this.map.setViewport(this.pointArray),this.pbIndex=0;for(var b=this.animatedPathArray.length-1;b>=0;b--)this.map.removeOverlay(this.animatedPathArray[b]);this.animatedPathArray=[];for(var b=this.stayMkArray.length-1;b>=0;b--)this.map.removeOverlay(this.stayMkArray[b]);this.stayMkArray=[]}this.pbFlat=!0,this.carMk.setZIndex(999),this.drawAnimatedLines("blue",a)},this.stopPlayBack=function(){this.pbFlat=!1;for(var a=this.animatedPathArray.length-1;a>=0;a--)this.map.removeOverlay(this.animatedPathArray[a]);this.animatedPathArray=[];for(var a=this.stayMkArray.length-1;a>=0;a--)this.map.removeOverlay(this.stayMkArray[a]);this.stayMkArray=[],this.pbIndex=0,this.carMk.setPosition(this.pointArray[0]),this.carMk.setRotation(135)},this.pausePlayBack=function(){this.pbFlat=!1},this.drawAnimatedLines=function(a,b){function c(b,d,e,f){function g(){if(j>k-1)clearTimeout(animating),animating=null,e.pbIndex++,e.pbIndex<e.pointArray.length-1?c(e.pointArray[e.pbIndex],e.pointArray[e.pbIndex+1],e,f):(e.pbFlat=!1,f(e.pbFlat));else{var b=new BMap.Point(l.lng+h/k,l.lat+i/k),d=new BMap.Polyline([l,b],{strokeColor:a,strokeOpacity:.8});e.animatedPathArray.push(d),e.map.addOverlay(d),e.carMk.setPosition(b),e.carMk.setRotation(135),l=b,j++,animating=setTimeout(arguments.callee,e.pbSpeed)}}var h=d.lng-b.lng,i=d.lat-b.lat,j=0,k=6,l=b;if(0==e.pbStayTimes){for(;e.pbIndex+e.pbStayTimes<e.datas.length-1&&e.datas[e.pbIndex+e.pbStayTimes][2]<1;)e.pbStayTimes++;if(e.pbStayTimes>4){var m=new BMap.Marker(b,{icon:new BMap.Icon("image/stop.png",new BMap.Size(39,56),{anchor:new BMap.Size(20,50)})});e.map.addOverlay(m),e.stayMkArray.push(m)}}else e.pbStayTimes--;g()}c(this.pointArray[this.pbIndex],this.pointArray[this.pbIndex+1],this,b)}},monitor=angular.module("monitorApp",["ui.router","ui.bootstrap","monitorCtrls","monitorDirectives"]);monitor.config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/PositionMonitor"),a.state("PositionMonitor",{url:"/PositionMonitor",templateUrl:"tpls/PositionMonitor.html",controller:"positionMonitor"}).state("Statistics",{url:"/Statistics",templateUrl:"tpls/Statistics.html",controller:"statistics"}).state("DeviceManagement",{url:"/DeviceManagement",templateUrl:"tpls/DeviceManagement.html",controller:"deviceManagement"}).state("Login",{url:"/Login",templateUrl:"tpls/Login.html"})}]);